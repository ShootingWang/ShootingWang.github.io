---
title: 天池 | 二手车交易数据
date: 2020-05-12 22:00:00
tags: [Data]
hide: true
math: true
toc: true
---

<center></center>
<!--more-->

# 数据说明
数据来源：[天池](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.68021b43DOhgme&postId=95422)

[数据详情](https://tianchi.aliyun.com/competition/entrance/231784/information)

> 本篇笔记的代码使用Jupyter Lab实现

## **参考资料**

[1] [Baseline方案](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95422)

[2] [赛题理解](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95456)

[3] [数据分析](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95457)

[4] [特征工程](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95501)

[5] [建模调参](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95460)

[6] [模型融合](https://tianchi.aliyun.com/notebook-ai/detail?spm=5176.12281978.0.0.6802593aEHEy7Y&postId=95535)

# 数据处理&分析

## 载入需要的模块


```python
## 基础模块
import numpy as np
import pandas as pd
import warnings
import matplotlib
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.special import jn
from IPython.display import display, clear_output
import time

warnings.filterwarnings('ignore')
%matplotlib inline

## 模型预测
from sklearn import linear_model
from sklearn import preprocessing
from sklearn.svm import SVR
from sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor
import lightgbm as lgb
import xgboost as xgb

## 降维
from sklearn.decomposition import PCA, FastICA, FactorAnalysis, SparsePCA

## 网格搜索、模型评估
from sklearn.model_selection import GridSearchCV, StratifiedKFold
from sklearn.model_selection import cross_val_score, train_test_split
from sklearn.metrics import mean_squared_error, mean_absolute_error
```

## 载入数据


```python
## 读取数据
train_data = pd.read_csv("used_car_train_20200313.csv", sep=" ")
testB_data = pd.read_csv("used_car_testB_20200421.csv", sep=" ")

## 训练集大小
print("Train data shape:", train_data.shape)
```

    Train data shape: (150000, 31)
    


```python
## 测试集大小
print("TestB data shape:", testB_data.shape)
```

    TestB data shape: (50000, 30)
    

## 数据预览


```python
train_data.head()  ## 预览前5行
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SaleID</th>
      <th>name</th>
      <th>regDate</th>
      <th>model</th>
      <th>brand</th>
      <th>bodyType</th>
      <th>fuelType</th>
      <th>gearbox</th>
      <th>power</th>
      <th>kilometer</th>
      <th>...</th>
      <th>v_5</th>
      <th>v_6</th>
      <th>v_7</th>
      <th>v_8</th>
      <th>v_9</th>
      <th>v_10</th>
      <th>v_11</th>
      <th>v_12</th>
      <th>v_13</th>
      <th>v_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>736</td>
      <td>20040402</td>
      <td>30.0</td>
      <td>6</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60</td>
      <td>12.5</td>
      <td>...</td>
      <td>0.235676</td>
      <td>0.101988</td>
      <td>0.129549</td>
      <td>0.022816</td>
      <td>0.097462</td>
      <td>-2.881803</td>
      <td>2.804097</td>
      <td>-2.420821</td>
      <td>0.795292</td>
      <td>0.914762</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2262</td>
      <td>20030301</td>
      <td>40.0</td>
      <td>1</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>15.0</td>
      <td>...</td>
      <td>0.264777</td>
      <td>0.121004</td>
      <td>0.135731</td>
      <td>0.026597</td>
      <td>0.020582</td>
      <td>-4.900482</td>
      <td>2.096338</td>
      <td>-1.030483</td>
      <td>-1.722674</td>
      <td>0.245522</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>14874</td>
      <td>20040403</td>
      <td>115.0</td>
      <td>15</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>163</td>
      <td>12.5</td>
      <td>...</td>
      <td>0.251410</td>
      <td>0.114912</td>
      <td>0.165147</td>
      <td>0.062173</td>
      <td>0.027075</td>
      <td>-4.846749</td>
      <td>1.803559</td>
      <td>1.565330</td>
      <td>-0.832687</td>
      <td>-0.229963</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>71865</td>
      <td>19960908</td>
      <td>109.0</td>
      <td>10</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>193</td>
      <td>15.0</td>
      <td>...</td>
      <td>0.274293</td>
      <td>0.110300</td>
      <td>0.121964</td>
      <td>0.033395</td>
      <td>0.000000</td>
      <td>-4.509599</td>
      <td>1.285940</td>
      <td>-0.501868</td>
      <td>-2.438353</td>
      <td>-0.478699</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>111080</td>
      <td>20120103</td>
      <td>110.0</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>68</td>
      <td>5.0</td>
      <td>...</td>
      <td>0.228036</td>
      <td>0.073205</td>
      <td>0.091880</td>
      <td>0.078819</td>
      <td>0.121534</td>
      <td>-1.896240</td>
      <td>0.910783</td>
      <td>0.931110</td>
      <td>2.834518</td>
      <td>1.923482</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 31 columns</p>
</div>




```python
train_data.tail()  ## 预览最后5行
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SaleID</th>
      <th>name</th>
      <th>regDate</th>
      <th>model</th>
      <th>brand</th>
      <th>bodyType</th>
      <th>fuelType</th>
      <th>gearbox</th>
      <th>power</th>
      <th>kilometer</th>
      <th>...</th>
      <th>v_5</th>
      <th>v_6</th>
      <th>v_7</th>
      <th>v_8</th>
      <th>v_9</th>
      <th>v_10</th>
      <th>v_11</th>
      <th>v_12</th>
      <th>v_13</th>
      <th>v_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>149995</th>
      <td>149995</td>
      <td>163978</td>
      <td>20000607</td>
      <td>121.0</td>
      <td>10</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>163</td>
      <td>15.0</td>
      <td>...</td>
      <td>0.280264</td>
      <td>0.000310</td>
      <td>0.048441</td>
      <td>0.071158</td>
      <td>0.019174</td>
      <td>1.988114</td>
      <td>-2.983973</td>
      <td>0.589167</td>
      <td>-1.304370</td>
      <td>-0.302592</td>
    </tr>
    <tr>
      <th>149996</th>
      <td>149996</td>
      <td>184535</td>
      <td>20091102</td>
      <td>116.0</td>
      <td>11</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>125</td>
      <td>10.0</td>
      <td>...</td>
      <td>0.253217</td>
      <td>0.000777</td>
      <td>0.084079</td>
      <td>0.099681</td>
      <td>0.079371</td>
      <td>1.839166</td>
      <td>-2.774615</td>
      <td>2.553994</td>
      <td>0.924196</td>
      <td>-0.272160</td>
    </tr>
    <tr>
      <th>149997</th>
      <td>149997</td>
      <td>147587</td>
      <td>20101003</td>
      <td>60.0</td>
      <td>11</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>90</td>
      <td>6.0</td>
      <td>...</td>
      <td>0.233353</td>
      <td>0.000705</td>
      <td>0.118872</td>
      <td>0.100118</td>
      <td>0.097914</td>
      <td>2.439812</td>
      <td>-1.630677</td>
      <td>2.290197</td>
      <td>1.891922</td>
      <td>0.414931</td>
    </tr>
    <tr>
      <th>149998</th>
      <td>149998</td>
      <td>45907</td>
      <td>20060312</td>
      <td>34.0</td>
      <td>10</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>156</td>
      <td>15.0</td>
      <td>...</td>
      <td>0.256369</td>
      <td>0.000252</td>
      <td>0.081479</td>
      <td>0.083558</td>
      <td>0.081498</td>
      <td>2.075380</td>
      <td>-2.633719</td>
      <td>1.414937</td>
      <td>0.431981</td>
      <td>-1.659014</td>
    </tr>
    <tr>
      <th>149999</th>
      <td>149999</td>
      <td>177672</td>
      <td>19990204</td>
      <td>19.0</td>
      <td>28</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>193</td>
      <td>12.5</td>
      <td>...</td>
      <td>0.284475</td>
      <td>0.000000</td>
      <td>0.040072</td>
      <td>0.062543</td>
      <td>0.025819</td>
      <td>1.978453</td>
      <td>-3.179913</td>
      <td>0.031724</td>
      <td>-1.483350</td>
      <td>-0.342674</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 31 columns</p>
</div>




```python
## .info()简要查看每列对应的数据类型、非缺失样本量
train_data.info()
## 总共有150000个样本量
## 149999表明'model'列有1个缺失值
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 150000 entries, 0 to 149999
    Data columns (total 31 columns):
    SaleID               150000 non-null int64
    name                 150000 non-null int64
    regDate              150000 non-null int64
    model                149999 non-null float64
    brand                150000 non-null int64
    bodyType             145494 non-null float64
    fuelType             141320 non-null float64
    gearbox              144019 non-null float64
    power                150000 non-null int64
    kilometer            150000 non-null float64
    notRepairedDamage    150000 non-null object
    regionCode           150000 non-null int64
    seller               150000 non-null int64
    offerType            150000 non-null int64
    creatDate            150000 non-null int64
    price                150000 non-null int64
    v_0                  150000 non-null float64
    v_1                  150000 non-null float64
    v_2                  150000 non-null float64
    v_3                  150000 non-null float64
    v_4                  150000 non-null float64
    v_5                  150000 non-null float64
    v_6                  150000 non-null float64
    v_7                  150000 non-null float64
    v_8                  150000 non-null float64
    v_9                  150000 non-null float64
    v_10                 150000 non-null float64
    v_11                 150000 non-null float64
    v_12                 150000 non-null float64
    v_13                 150000 non-null float64
    v_14                 150000 non-null float64
    dtypes: float64(20), int64(10), object(1)
    memory usage: 35.5+ MB
    


```python
train_data.columns  ## 查看所有列名
```




    Index(['SaleID', 'name', 'regDate', 'model', 'brand', 'bodyType', 'fuelType',
           'gearbox', 'power', 'kilometer', 'notRepairedDamage', 'regionCode',
           'seller', 'offerType', 'creatDate', 'price', 'v_0', 'v_1', 'v_2', 'v_3',
           'v_4', 'v_5', 'v_6', 'v_7', 'v_8', 'v_9', 'v_10', 'v_11', 'v_12',
           'v_13', 'v_14'],
          dtype='object')




```python
testB_data.info()
## 测试集有50000个样本
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 50000 entries, 0 to 49999
    Data columns (total 30 columns):
    SaleID               50000 non-null int64
    name                 50000 non-null int64
    regDate              50000 non-null int64
    model                50000 non-null float64
    brand                50000 non-null int64
    bodyType             48496 non-null float64
    fuelType             47076 non-null float64
    gearbox              48032 non-null float64
    power                50000 non-null int64
    kilometer            50000 non-null float64
    notRepairedDamage    50000 non-null object
    regionCode           50000 non-null int64
    seller               50000 non-null int64
    offerType            50000 non-null int64
    creatDate            50000 non-null int64
    v_0                  50000 non-null float64
    v_1                  50000 non-null float64
    v_2                  50000 non-null float64
    v_3                  50000 non-null float64
    v_4                  50000 non-null float64
    v_5                  50000 non-null float64
    v_6                  50000 non-null float64
    v_7                  50000 non-null float64
    v_8                  50000 non-null float64
    v_9                  50000 non-null float64
    v_10                 50000 non-null float64
    v_11                 50000 non-null float64
    v_12                 50000 non-null float64
    v_13                 50000 non-null float64
    v_14                 50000 non-null float64
    dtypes: float64(20), int64(9), object(1)
    memory usage: 11.4+ MB
    


```python
## 描述性统计
train_data.describe()
## 查看每列的非空样本量、均值mean、标准差std、最小值min、25%分位数、
## 中位数（即50%分位数）、75%分位数、最大值max
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SaleID</th>
      <th>name</th>
      <th>regDate</th>
      <th>model</th>
      <th>brand</th>
      <th>bodyType</th>
      <th>fuelType</th>
      <th>gearbox</th>
      <th>power</th>
      <th>kilometer</th>
      <th>...</th>
      <th>v_5</th>
      <th>v_6</th>
      <th>v_7</th>
      <th>v_8</th>
      <th>v_9</th>
      <th>v_10</th>
      <th>v_11</th>
      <th>v_12</th>
      <th>v_13</th>
      <th>v_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>1.500000e+05</td>
      <td>149999.000000</td>
      <td>150000.000000</td>
      <td>145494.000000</td>
      <td>141320.000000</td>
      <td>144019.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>...</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
      <td>150000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>74999.500000</td>
      <td>68349.172873</td>
      <td>2.003417e+07</td>
      <td>47.129021</td>
      <td>8.052733</td>
      <td>1.792369</td>
      <td>0.375842</td>
      <td>0.224943</td>
      <td>119.316547</td>
      <td>12.597160</td>
      <td>...</td>
      <td>0.248204</td>
      <td>0.044923</td>
      <td>0.124692</td>
      <td>0.058144</td>
      <td>0.061996</td>
      <td>-0.001000</td>
      <td>0.009035</td>
      <td>0.004813</td>
      <td>0.000313</td>
      <td>-0.000688</td>
    </tr>
    <tr>
      <th>std</th>
      <td>43301.414527</td>
      <td>61103.875095</td>
      <td>5.364988e+04</td>
      <td>49.536040</td>
      <td>7.864956</td>
      <td>1.760640</td>
      <td>0.548677</td>
      <td>0.417546</td>
      <td>177.168419</td>
      <td>3.919576</td>
      <td>...</td>
      <td>0.045804</td>
      <td>0.051743</td>
      <td>0.201410</td>
      <td>0.029186</td>
      <td>0.035692</td>
      <td>3.772386</td>
      <td>3.286071</td>
      <td>2.517478</td>
      <td>1.288988</td>
      <td>1.038685</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.991000e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-9.168192</td>
      <td>-5.558207</td>
      <td>-9.639552</td>
      <td>-4.153899</td>
      <td>-6.546556</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>37499.750000</td>
      <td>11156.000000</td>
      <td>1.999091e+07</td>
      <td>10.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>75.000000</td>
      <td>12.500000</td>
      <td>...</td>
      <td>0.243615</td>
      <td>0.000038</td>
      <td>0.062474</td>
      <td>0.035334</td>
      <td>0.033930</td>
      <td>-3.722303</td>
      <td>-1.951543</td>
      <td>-1.871846</td>
      <td>-1.057789</td>
      <td>-0.437034</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>74999.500000</td>
      <td>51638.000000</td>
      <td>2.003091e+07</td>
      <td>30.000000</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>110.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.257798</td>
      <td>0.000812</td>
      <td>0.095866</td>
      <td>0.057014</td>
      <td>0.058484</td>
      <td>1.624076</td>
      <td>-0.358053</td>
      <td>-0.130753</td>
      <td>-0.036245</td>
      <td>0.141246</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>112499.250000</td>
      <td>118841.250000</td>
      <td>2.007111e+07</td>
      <td>66.000000</td>
      <td>13.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>150.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.265297</td>
      <td>0.102009</td>
      <td>0.125243</td>
      <td>0.079382</td>
      <td>0.087491</td>
      <td>2.844357</td>
      <td>1.255022</td>
      <td>1.776933</td>
      <td>0.942813</td>
      <td>0.680378</td>
    </tr>
    <tr>
      <th>max</th>
      <td>149999.000000</td>
      <td>196812.000000</td>
      <td>2.015121e+07</td>
      <td>247.000000</td>
      <td>39.000000</td>
      <td>7.000000</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>19312.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.291838</td>
      <td>0.151420</td>
      <td>1.404936</td>
      <td>0.160791</td>
      <td>0.222787</td>
      <td>12.357011</td>
      <td>18.819042</td>
      <td>13.847792</td>
      <td>11.147669</td>
      <td>8.658418</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 30 columns</p>
</div>




```python
testB_data.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SaleID</th>
      <th>name</th>
      <th>regDate</th>
      <th>model</th>
      <th>brand</th>
      <th>bodyType</th>
      <th>fuelType</th>
      <th>gearbox</th>
      <th>power</th>
      <th>kilometer</th>
      <th>...</th>
      <th>v_5</th>
      <th>v_6</th>
      <th>v_7</th>
      <th>v_8</th>
      <th>v_9</th>
      <th>v_10</th>
      <th>v_11</th>
      <th>v_12</th>
      <th>v_13</th>
      <th>v_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>5.000000e+04</td>
      <td>50000.00000</td>
      <td>50000.000000</td>
      <td>48496.000000</td>
      <td>47076.000000</td>
      <td>48032.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>...</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>50000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>224999.500000</td>
      <td>68505.606100</td>
      <td>2.003401e+07</td>
      <td>47.64948</td>
      <td>8.087140</td>
      <td>1.793736</td>
      <td>0.376498</td>
      <td>0.226953</td>
      <td>119.766960</td>
      <td>12.598260</td>
      <td>...</td>
      <td>0.248147</td>
      <td>0.044624</td>
      <td>0.124693</td>
      <td>0.058198</td>
      <td>0.062113</td>
      <td>0.019633</td>
      <td>0.002759</td>
      <td>0.004342</td>
      <td>0.004570</td>
      <td>-0.007209</td>
    </tr>
    <tr>
      <th>std</th>
      <td>14433.901067</td>
      <td>61032.124271</td>
      <td>5.351615e+04</td>
      <td>49.90741</td>
      <td>7.899648</td>
      <td>1.764970</td>
      <td>0.549281</td>
      <td>0.418866</td>
      <td>206.313348</td>
      <td>3.912519</td>
      <td>...</td>
      <td>0.045836</td>
      <td>0.051664</td>
      <td>0.201440</td>
      <td>0.029171</td>
      <td>0.035723</td>
      <td>3.764095</td>
      <td>3.289523</td>
      <td>2.515912</td>
      <td>1.287194</td>
      <td>1.044718</td>
    </tr>
    <tr>
      <th>min</th>
      <td>200000.000000</td>
      <td>1.000000</td>
      <td>1.991000e+07</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-9.119719</td>
      <td>-5.662163</td>
      <td>-8.291868</td>
      <td>-4.157649</td>
      <td>-6.098192</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>212499.750000</td>
      <td>11315.000000</td>
      <td>1.999100e+07</td>
      <td>11.00000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>75.000000</td>
      <td>12.500000</td>
      <td>...</td>
      <td>0.243436</td>
      <td>0.000035</td>
      <td>0.062519</td>
      <td>0.035413</td>
      <td>0.033880</td>
      <td>-3.675196</td>
      <td>-1.963928</td>
      <td>-1.865406</td>
      <td>-1.048722</td>
      <td>-0.440706</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>224999.500000</td>
      <td>52215.000000</td>
      <td>2.003091e+07</td>
      <td>30.00000</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>110.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.257818</td>
      <td>0.000801</td>
      <td>0.095880</td>
      <td>0.056804</td>
      <td>0.058749</td>
      <td>1.632134</td>
      <td>-0.375537</td>
      <td>-0.138943</td>
      <td>-0.036352</td>
      <td>0.136849</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>237499.250000</td>
      <td>118710.750000</td>
      <td>2.007110e+07</td>
      <td>66.00000</td>
      <td>13.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>150.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.265263</td>
      <td>0.101654</td>
      <td>0.125470</td>
      <td>0.079387</td>
      <td>0.087624</td>
      <td>2.846205</td>
      <td>1.263451</td>
      <td>1.775632</td>
      <td>0.945239</td>
      <td>0.685555</td>
    </tr>
    <tr>
      <th>max</th>
      <td>249999.000000</td>
      <td>196808.000000</td>
      <td>2.015121e+07</td>
      <td>246.00000</td>
      <td>39.000000</td>
      <td>7.000000</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>19211.000000</td>
      <td>15.000000</td>
      <td>...</td>
      <td>0.291176</td>
      <td>0.153403</td>
      <td>1.411559</td>
      <td>0.157458</td>
      <td>0.211304</td>
      <td>12.177864</td>
      <td>18.789496</td>
      <td>13.384828</td>
      <td>5.635374</td>
      <td>2.649768</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 29 columns</p>
</div>



## 数据特征


```python
## 提取数值型特征列名
numerical_cols = train_data.select_dtypes(exclude='object').columns
print(numerical_cols)
```

    Index(['SaleID', 'name', 'regDate', 'model', 'brand', 'bodyType', 'fuelType',
           'gearbox', 'power', 'kilometer', 'regionCode', 'seller', 'offerType',
           'creatDate', 'price', 'v_0', 'v_1', 'v_2', 'v_3', 'v_4', 'v_5', 'v_6',
           'v_7', 'v_8', 'v_9', 'v_10', 'v_11', 'v_12', 'v_13', 'v_14'],
          dtype='object')
    


```python
## 提取非数值型特征列名
categorical_cols = train_data.select_dtypes(include='object').columns
print(categorical_cols)
```

    Index(['notRepairedDamage'], dtype='object')
    

## 训练集和测试集


```python
## 选择特征列
feature_cols = [col for col in numerical_cols if col not in ['SaleID', 'name', 'regDate','creatDate','price','model','brand','regionCode','seller']]
feature_cols = [col for col in feature_cols if 'Type' not in col]
```


```python
## 提取特征列、标签列构造训练集和测试集
X_train = train_data[feature_cols]  ## 训练集特征
y_train = train_data['price']  ## 训练集标签

X_test = testB_data[feature_cols]  ## 测试集标签

print('X train shape is :', X_train.shape)
print('X test shape is :', X_test.shape)
```

    X train shape is : (150000, 18)
    X test shape is : (50000, 18)
    


```python
## 统计标签的基本分布信息
def stat_info(data):
    print('_min', np.min(data))
    print('_max', np.max(data))
    print('_mean', np.mean(data))
    print('_ptp', np.ptp(data))  ## 最大值与最小值的差
    print('_std', np.std(data))
    print('_var', np.var(data))

print('Stat of label:')
stat_info(y_train)
```

    Stat of label:
    _min 11
    _max 99999
    _mean 5923.327333333334
    _ptp 99988
    _std 7501.973469876438
    _var 56279605.94272992
    


```python
## label中可能存在异常大值
## 绘制标签的直方图，查看标签分布
plt.hist(y_train)
plt.show()
plt.close()
```

<meta name="referrer" content="no-referrer" />
{% asset_img output_23_0.png 直方图 %}


```python
## 填补缺失值
X_train = X_train.fillna(-1)  ## 用-1填补
X_test = X_test.fillna(-1)
```

# 模型


```python
## 利用XGBoost进行5折交叉验证
xgb_reg = xgb.XGBRegressor(
    n_estimators=120, 
    learning_rate=0.1, 
    gamma=0,
    subsample=0.8,
    colsample_bytree=0.9,
    max_depth=7,
    objective='reg:squarederror'
)
scores_train = []
scores = []

## 5折交叉验证
folds = StratifiedKFold(n_splits=5, shuffle=True, random_state=0)
for train_idx, val_idx in folds.split(X_train, y_train):
    train_X = X_train.iloc[train_idx].values
    train_y = y_train.iloc[train_idx]
    val_X = X_train.iloc[val_idx].values
    val_y = y_train.iloc[val_idx]
    
    xgb_reg.fit(train_X, train_y)
    pred_train_y_xgb = xgb_reg.predict(train_X)
    pred_val_y_xgb = xgb_reg.predict(val_X)
    
    score_train = mean_absolute_error(train_y, pred_train_y_xgb)
    scores_train.append(score_train)
    score = mean_absolute_error(val_y, pred_val_y_xgb)
    scores.append(score)
    
print('Train MAE:', np.mean(score_train))
print('Validation MAE:', np.mean(scores))
```

    Train MAE: 622.8334142499367
    Validation MAE: 713.7602744693083
    


```python
## 定义xgb和lgb模型函数
def XGB_model(x_train, y_train):
    model = xgb.XGBRegressor(
        n_estimators=150,
        learning_rate=0.1,
        gamma=0,
        subsample=0.8,
        colsample_bytree=0.9,
        max_depth=7,
        objective='reg:squarederror'
    )
    model.fit(x_train, y_train)
    return model

def LGB_model(x_train, y_train):
    estimator = lgb.LGBMRegressor(
        num_leaves=127,
        n_estimators=150
    )
    param_grid = {
        'learning_rate': [0.01, 0.05, 0.1, 0.2],
    }
    gbm = GridSearchCV(estimator, param_grid)
    gbm.fit(x_train, y_train)
    return gbm
```


```python
## 切分训练集和验证集
x_train, x_val, yy_train, y_val = train_test_split(X_train, y_train, test_size=0.3)
```


```python
print("Training LGB ...")
model_lgb = LGB_model(x_train, yy_train)
val_lgb = model_lgb.predict(x_val)
MAE_lgb = mean_absolute_error(y_val, val_lgb)
print("MAE of val with LGB:", MAE_lgb)

print("Predict LGB ...")
model_lgb_pred = LGB_model(X_train, y_train)
subB_lgb = model_lgb_pred.predict(X_test)
print("stat of Predict LGB:")
stat_info(subB_lgb)
```

    Training LGB ...
    MAE of val with LGB: 687.1736052804791
    Predict LGB ...
    stat of Predict LGB:
    _min -589.8793550785414
    _max 90760.26063584947
    _mean 5906.935218383807
    _ptp 91350.13999092802
    _std 7344.644970956768
    _var 53943809.749400534
    


```python
print("Training XGB ...")
model_xgb = XGB_model(x_train, yy_train)
val_xgb = model_xgb.predict(x_val)
MAE_xgb = mean_absolute_error(y_val, val_xgb)
print("MAE of val with xgb:", MAE_xgb)

print("Predict xgb ...")
model_xgb_pred = XGB_model(X_train, y_train)
subB_xgb = model_xgb_pred.predict(X_test)
print("Stat of Predict XGB:")
stat_info(subB_xgb)
```

    Training XGB ...
    MAE of val with xgb: 713.8987584188461
    Predict xgb ...
    Stat of Predict XGB:
    _min -318.2115
    _max 90140.625
    _mean 5910.76
    _ptp 90458.836
    _std 7345.9653
    _var 53963204.0
    


```python
## 加权融合两模型的结果
val_weighted = (1 - MAE_lgb / (MAE_xgb + MAE_lgb)) * val_lgb + (1 - MAE_xgb / (MAE_xgb + MAE_lgb) * val_xgb)
val_weighted[val_weighted < 0] = 10  ## 修正预测值为负的样本
print("MAE of val with weighted ensemble:", mean_absolute_error(y_val, val_weighted))
```

    MAE of val with weighted ensemble: 5888.071354671169
    


```python
sub_weighted = (1 - MAE_lgb / (MAE_xgb + MAE_lgb)) * subB_lgb + (1 - MAE_xgb / (MAE_xgb + MAE_lgb)) * subB_xgb
```


```python
## 查看预测值的直方图
plt.hist(sub_weighted)
plt.show()
plt.close()
```

<meta name="referrer" content="no-referrer" />
{% asset_img output_33_0.png 直方图 %}



# 输出结果


```python
sub = pd.DataFrame()
sub['SaleID'] = testB_data.SaleID
sub['price'] = sub_weighted
sub.to_csv("./sub_weighted.csv", index=False)
```


```python
sub.head()  ## 预览结果
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SaleID</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>200000</td>
      <td>1177.409043</td>
    </tr>
    <tr>
      <th>1</th>
      <td>200001</td>
      <td>1806.548102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>200002</td>
      <td>8560.376569</td>
    </tr>
    <tr>
      <th>3</th>
      <td>200003</td>
      <td>1346.403363</td>
    </tr>
    <tr>
      <th>4</th>
      <td>200004</td>
      <td>2074.413901</td>
    </tr>
  </tbody>
</table>
</div>

